# Requires latest ansible devel
- name: "Docker run haproxy"
  when: haproxy_setup | default(false) | bool == True or (not haproxy_container.exists or haproxy_container.container.State.Status != 'running')
  become: True
  docker_container:
    container_default_behavior: compatibility
    image: "this-haproxy:{{ haproxy_image_version | default('2.0.10') }}"
    hostname: "{{ ansible_inventory }}"
    name: haproxy
    state: started
    restart_policy: unless-stopped
    ports:
      - 0.0.0.0:80:80 #HTTP
      - 0.0.0.0:443:443 #HTTPS
      - 0.0.0.0:1194:1194 #OPENVPN
      - 0.0.0.0:7999:7999 #ACME
      - 0.0.0.0:8000:8000 #HAProxyStats
      - 0.0.0.0:8003:8003 #HAProxy Exporter
      - 0.0.0.0:8080:8080 #Something else
    recreate: true
    volumes:
      - /haproxy_config:/haproxy_config
      - /haproxy_certs:/etc/ssl/private
    capabilities:
      - NET_ADMIN
    env:
      HAPROXY_CONFIG: /haproxy_config/haproxy.cfg
      HAPROXY_PORTS: 80,443,1194,7999,8000,8080 #This is important.
